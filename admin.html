// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyBXVrbfucAyj9wud-sY2BaO2mLO8JaeeQE",
    authDomain: "ship-53cd8.firebaseapp.com",
    databaseURL: "https://ship-53cd8-default-rtdb.firebaseio.com",
    projectId: "ship-53cd8",
    storageBucket: "ship-53cd8.firebasestorage.app",
    messagingSenderId: "682363394250",
    appId: "1:682363394250:web:705c36de45058f4a26bc33"
};

// Initialize
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let allOrders = [];

/**
 * 1. Fetch Orders in Real-Time
 */
function fetchOrders() {
    database.ref('orders').on('value', (snapshot) => {
        const data = snapshot.val();
        allOrders = [];

        if (data) {
            Object.keys(data).forEach(id => {
                allOrders.push({ id, ...data[id] });
            });
            // Newest first
            allOrders.reverse();
        }

        calculateStats(allOrders);
        renderOrders(allOrders);
    }, (error) => {
        console.error("Database Error: ", error);
    });
}

/**
 * 2. Calculate Dashboard Stats
 */
function calculateStats(orders) {
    let revenue = 0;
    let counts = {
        total: orders.length,
        new: 0,
        processing: 0,
        shipped: 0,
        delivered: 0,
        cancelled: 0
    };

    orders.forEach(order => {
        // Convert total to number safely
        const amount = parseFloat(order.total) || 0;
        revenue += amount;

        const status = (order.status || 'New').toLowerCase();
        if (status === 'new') counts.new++;
        else if (status === 'processing') counts.processing++;
        else if (status === 'shipped') counts.shipped++;
        else if (status === 'delivered') counts.delivered++;
        else if (status === 'cancelled') counts.cancelled++;
    });

    // Update DOM
    document.getElementById('totalRevenue').innerText = `₹${revenue.toLocaleString()}`;
    document.getElementById('totalOrders').innerText = counts.total;
    document.getElementById('newCount').innerText = counts.new;
    document.getElementById('processingCount').innerText = counts.processing;
    document.getElementById('shippedCount').innerText = counts.shipped;
    document.getElementById('deliveredCount').innerText = counts.delivered;
    document.getElementById('cancelledCount').innerText = counts.cancelled;
}

/**
 * 3. Render Table UI
 */
function renderOrders(orders) {
    const listBody = document.getElementById('orderList');
    const searchVal = document.getElementById('searchInput').value.toLowerCase();
    listBody.innerHTML = '';

    const filtered = orders.filter(o => 
        o.name.toLowerCase().includes(searchVal) || 
        o.phone.includes(searchVal)
    );

    if (filtered.length === 0) {
        listBody.innerHTML = `<tr><td colspan="6" class="p-10 text-center text-gray-400">No matching orders found.</td></tr>`;
        return;
    }

    filtered.forEach(order => {
        const row = document.createElement('tr');
        row.className = "hover:bg-gray-50 transition";
        
        const status = order.status || 'New';
        const badgeClass = `badge-${status.toLowerCase()}`;

        row.innerHTML = `
            <td class="p-6">
                <div class="text-xs font-bold text-gray-400">#${order.id.slice(-6)}</div>
                <div class="text-[10px] text-gray-500 font-medium mt-1">${order.time || 'Date Unknown'}</div>
            </td>
            <td class="p-6">
                <div class="text-sm font-bold text-gray-800">${order.name}</div>
                <div class="text-xs text-blue-600 font-medium underline underline-offset-4">${order.phone}</div>
                <div class="text-[10px] text-gray-400 mt-1 max-w-[200px] truncate">${order.address}</div>
            </td>
            <td class="p-6 font-bold text-primary">₹${parseFloat(order.total || 0).toLocaleString()}</td>
            <td class="p-6">
                <span class="status-badge ${badgeClass}">${status}</span>
            </td>
            <td class="p-6">
                <div class="flex flex-wrap justify-center gap-2">
                    <button onclick="updateStatus('${order.id}', 'Processing')" class="text-[10px] font-bold px-3 py-1 bg-blue-50 text-blue-600 border border-blue-200 rounded-md hover:bg-blue-600 hover:text-white transition">Processing</button>
                    <button onclick="updateStatus('${order.id}', 'Shipped')" class="text-[10px] font-bold px-3 py-1 bg-green-50 text-green-600 border border-green-200 rounded-md hover:bg-green-600 hover:text-white transition">Shipped</button>
                    <button onclick="updateStatus('${order.id}', 'Delivered')" class="text-[10px] font-bold px-3 py-1 bg-purple-50 text-purple-600 border border-purple-200 rounded-md hover:bg-purple-600 hover:text-white transition">Delivered</button>
                    <button onclick="updateStatus('${order.id}', 'Cancelled')" class="text-[10px] font-bold px-3 py-1 bg-red-50 text-red-600 border border-red-200 rounded-md hover:bg-red-600 hover:text-white transition">Cancel</button>
                </div>
            </td>
            <td class="p-6 text-center">
                <button onclick="deleteOrder('${order.id}')" class="text-gray-300 hover:text-red-500 transition px-2">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </td>
        `;
        listBody.appendChild(row);
    });
}

/**
 * 4. Update Status (One-Click)
 */
function updateStatus(id, newStatus) {
    database.ref('orders/' + id).update({
        status: newStatus
    }).then(() => {
        console.log(`Order ${id} updated to ${newStatus}`);
    }).catch(err => {
        alert("Update failed: " + err.message);
    });
}

/**
 * 5. Delete Logic
 */
function deleteOrder(id) {
    if (confirm("Permanently delete this order data?")) {
        database.ref('orders/' + id).remove();
    }
}

// Start Fetching on Load
window.onload = fetchOrders;
